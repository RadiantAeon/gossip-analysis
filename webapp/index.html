<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Validator Analysis Dashboard</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: "Segoe UI", Helvetica, Arial, sans-serif;
        background: #f7f8fa;
        color: #1f2933;
      }

      #root {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }

      #legend {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #d2d6dc;
        border-radius: 8px;
        padding: 12px 16px;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.15);
        z-index: 10;
        min-width: 180px;
      }

      #metadata {
        position: absolute;
        bottom: 16px;
        right: 16px;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #d2d6dc;
        border-radius: 8px;
        padding: 12px 16px;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.15);
        z-index: 10;
        min-width: 260px;
        max-width: 40%;
      }

      #metadata .meta-title {
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 14px;
      }

      #metadata .meta-row {
        display: flex;
        gap: 8px;
        margin: 4px 0;
        font-size: 13px;
      }

      #metadata .meta-key {
        color: #6b7280;
        min-width: 100px;
      }

      #metadata .meta-value {
        color: #1f2937;
        word-break: break-word;
      }

      #legend .legend-title {
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 14px;
      }

      #legend .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        margin-bottom: 6px;
      }

      #legend .legend-item:last-child {
        margin-bottom: 0;
      }

      #legend .legend-swatch {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid rgba(31, 41, 51, 0.4);
      }
    </style>
  </head>

  <script
    type="text/javascript"
    src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"
  ></script>
  
  <body>
    <div id="selected-nodes" style="position:absolute;top:16px;left:16px;bottom:16px;z-index:10;background:rgba(255,255,255,0.95);border:1px solid #d2d6dc;border-radius:8px;padding:12px 16px;box-shadow:0 4px 12px rgba(15, 23, 42, 0.15);min-width:320px;max-width:32%;display:flex;flex-direction:column;gap:10px;overflow-x:hidden;">
      <div style="font-weight:600;font-size:14px;">Selected Nodes</div>
      <input id="search-input" type="text" placeholder="Search by node titleâ€¦" style="width:100%;padding:8px;border:1px solid #d2d6dc;border-radius:6px;font-size:13px;box-sizing:border-box;display:block;" />
      <div id="selected-nodes-list" style="display:flex;flex-direction:column;gap:8px;font-size:12px;color:#1f2937;overflow:auto;flex:1;min-height:0;"></div>
    </div>
    <div id="legend">
    </div>
    <div id="root"></div>
    <div id="metadata"></div>
    <script>
      const groupStyles = {
        JITO: { label: 'Jito pool', color: '#008000', border: 'darkgreen' },
        SFDP: { label: 'SFDP only', color: '#eee600', border: 'brown' },
        SFDPandJito: { label: 'Jito + SFDP', color: '#e30022', border: 'darkred' },
        Regular: { label: 'No program', color: '#0000cd', border: 'black' },
      };

      const legend = document.getElementById('legend');
      const container = document.getElementById('root');

      const options = {
        width: '100%',
        height: '100%',
        edges: {
          color: 'black',
        },
        nodes: {
          shape: 'dot',
          scaling: {
            min: 50,
            max: 300,
          },
        },
        groups: {},
        physics: {
          barnesHut: {
            springLength: 350,
          },
        },
        layout: {
          improvedLayout: false,
        },
      };

      function populateLegend(target, styles, visOptions) {
        const legendTitle = document.createElement('div');
        legendTitle.className = 'legend-title';
        legendTitle.textContent = 'Legend';
        target.appendChild(legendTitle);

        Object.entries(styles).forEach(([groupName, config]) => {
          visOptions.groups[groupName] = {
            color: {
              background: config.color,
              border: config.border,
              highlight: {
                background: config.color,
                border: '#111827',
              },
              hover: {
                background: config.color,
                border: '#111827',
              },
            },
          };

          const item = document.createElement('div');
          item.className = 'legend-item';

          const swatch = document.createElement('span');
          swatch.className = 'legend-swatch';
          swatch.style.backgroundColor = config.color;

          const label = document.createElement('span');
          label.textContent = config.label;

          item.appendChild(swatch);
          item.appendChild(label);
          target.appendChild(item);
        });
      }

      populateLegend(legend, groupStyles, options);

      function populateMetadata(network) {
        const panel = document.getElementById('metadata');

        function render(titleText, rows) {
          panel.innerHTML = '';
          const title = document.createElement('div');
          title.className = 'meta-title';
          title.textContent = titleText;
          panel.appendChild(title);

          rows.forEach(([key, value]) => {
            const row = document.createElement('div');
            row.className = 'meta-row';
            const k = document.createElement('div');
            k.className = 'meta-key';
            k.textContent = key;
            const v = document.createElement('div');
            v.className = 'meta-value';
            v.textContent = value;
            row.appendChild(k);
            row.appendChild(v);
            panel.appendChild(row);
          });
        }

        function onSelectHandler (params) {
          const counts = { JITO: 0, SFDP: 0, SFDPandJito: 0, Regular: 0 };
          const titles = [];
          const stake = params.nodes.reduce((acc, nodeId) => {
            const node = network.body.nodes[nodeId];
            const value = node?.options?.value ?? 0;
            const group = node?.options?.group ?? 'Regular';
            if (group in counts) counts[group] += 1; else counts.Regular += 1;
            titles.push(node.options.title)
            return acc + value;
          }
          , 0);
          // Render selected titles in the left sidebar
          const listEl = document.getElementById('selected-nodes-list');
          if (listEl) {
            listEl.innerHTML = '';
            if (titles.length === 0) {
              const empty = document.createElement('div');
              empty.style.color = '#6b7280';
              empty.textContent = 'No nodes selected.';
              listEl.appendChild(empty);
            } else {
              titles.forEach((title) => {
                const item = document.createElement('div');
                item.style.border = '1px solid #e5e7eb';
                item.style.borderRadius = '6px';
                item.style.padding = '8px';
                item.style.background = '#ffffff';
                item.style.whiteSpace = 'pre-wrap';
                item.textContent = title;
                listEl.appendChild(item);
              });
            }
          }
          const rows = [
            ['Total Stake (SOL)', stake.toLocaleString('en-US')],
            ['Number of Validators', String(params.nodes.length)],
            ['Jito pool', String(counts.JITO)],
            ['SFDP only', String(counts.SFDP)],
            ['Jito + SFDP', String(counts.SFDPandJito)],
            ['No program', String(counts.Regular)],
          ];
          render('Selected Validators', rows);
        };

        network.on('select', onSelectHandler);

        // initial state
        render('No Selection', [['Hint', 'Click or drag select nodes to see details']]);
      }

      fetch('sybil_analysis_output.json')
        .then((response) => response.json())
        .then((data) => {
          const nodes = data.nodes;
          const edges = data.edges;
          let network = new vis.Network(container, { nodes, edges }, options);

          // grab metadata
          populateMetadata(network);

          // Build a map from node id to title for faster search
          const idToTitle = new Map();
          nodes.forEach(n => {
            if (typeof n.title === 'string') {
              idToTitle.set(n.id, n.title);
            } else {
              idToTitle.set(n.id, '');
            }
          });

          // Search functionality: match input text against node titles (case-insensitive)
          const input = document.getElementById('search-input');
          let searchTimer = null;
          function performSearch(query) {
            const q = (query || '').trim().toLowerCase();
            if (!q) {
              // clear selection when query is empty
              network.unselectAll();
              return;
            }
            const matchingIds = [];
            idToTitle.forEach((title, id) => {
              if (title.toLowerCase().includes(q)) {
                matchingIds.push(id);
              }
            });

            if (matchingIds.length > 0) {
              // Select nodes and center focus on selection
              network.selectNodes(matchingIds, false);
              network.focus(matchingIds[0], { scale: 1.0, animation: true });
            } else {
              // No matches: clear selection
              network.unselectAll();
            }
            onSelectHandler({ nodes: matchingIds });
          }

          input.addEventListener('input', () => {
            if (searchTimer) clearTimeout(searchTimer);
            searchTimer = setTimeout(() => performSearch(input.value), 200);
          });
        });
    </script>
  </body>
</html>