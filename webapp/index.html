<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Validator Analysis Dashboard</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: "Segoe UI", Helvetica, Arial, sans-serif;
        background: #f7f8fa;
        color: #1f2933;
      }

      #root {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }

      #legend {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #d2d6dc;
        border-radius: 8px;
        padding: 12px 16px;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.15);
        z-index: 10;
        min-width: 180px;
      }

      #metadata {
        position: absolute;
        bottom: 16px;
        right: 16px;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #d2d6dc;
        border-radius: 8px;
        padding: 12px 16px;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.15);
        z-index: 10;
        min-width: 260px;
        max-width: 40%;
      }

      #metadata .meta-title {
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 14px;
      }

      #metadata .meta-row {
        display: flex;
        gap: 8px;
        margin: 4px 0;
        font-size: 13px;
      }

      #metadata .meta-key {
        color: #6b7280;
        min-width: 100px;
      }

      #metadata .meta-value {
        color: #1f2937;
        word-break: break-word;
      }

      #legend .legend-title {
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 14px;
      }

      #legend .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        margin-bottom: 6px;
      }

      #legend .legend-item:last-child {
        margin-bottom: 0;
      }

      #legend .legend-swatch {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid rgba(31, 41, 51, 0.4);
      }

      #physics-toggle {
        padding: 8px 12px;
        background: white;
        border: 1px solid #d2d6dc;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      #physics-toggle:hover {
        background: #f9fafb;
        border-color: #9ca3af;
      }

      #physics-toggle.active {
        background: #10b981;
        color: white;
        border-color: #059669;
      }
    </style>
  </head>

  <script
    type="text/javascript"
    src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"
  ></script>
  
  <body>
    <div id="selected-nodes" style="position:absolute;top:16px;left:16px;bottom:16px;z-index:10;background:rgba(255,255,255,0.95);border:1px solid #d2d6dc;border-radius:8px;padding:12px 16px;box-shadow:0 4px 12px rgba(15, 23, 42, 0.15);min-width:320px;max-width:32%;display:flex;flex-direction:column;gap:10px;overflow-x:hidden;">
      <div style="font-weight:600;font-size:14px;">Selected Nodes</div>
      <div style="display:flex;align-items:center;gap:8px;">
        <select id="data-source-selector" style="padding:8px;border:1px solid #d2d6dc;border-radius:6px;font-size:13px;background:#ffffff;cursor:pointer;">
          <option value="sybil_analysis_output.json">Current Data</option>
          <option value="sybil_analysis_output_before.json">Before Data</option>
        </select>
        <button id="physics-toggle" class="active">Physics: ON</button>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <input id="search-input" type="text" placeholder="Search by node titleâ€¦" style="flex:1;padding:8px;border:1px solid #d2d6dc;border-radius:6px;font-size:13px;box-sizing:border-box;display:block;" />
        <button id="export-csv" style="padding:8px 12px;font-size:12px;border:1px solid #d2d6dc;border-radius:6px;background:#f9fafb;color:#111827;cursor:pointer;white-space:nowrap;">Export CSV</button>
      </div>
      <div id="selected-nodes-list" style="display:flex;flex-direction:column;gap:8px;font-size:12px;color:#1f2937;overflow:auto;flex:1;min-height:0;"></div>
    </div>
    <div id="legend">
    </div>
    <div id="root"></div>
    <div id="metadata"></div>
    <script>
      const groupStyles = {
        JITO: { label: 'Jito pool', color: '#008000', border: 'darkgreen' },
        SFDP: { label: 'SFDP only', color: '#eee600', border: 'brown' },
        SFDPandJito: { label: 'Jito + SFDP', color: '#e30022', border: 'darkred' },
        Regular: { label: 'No program', color: '#0000cd', border: 'black' },
      };

      const legend = document.getElementById('legend');
      const container = document.getElementById('root');

      const options = {
        width: '100%',
        height: '100%',
        edges: {
          color: 'black',
        },
        nodes: {
          shape: 'circularImage',
          scaling: {
            min: 50,
            max: 300,
          },
          borderWidth: 6,
        },
        groups: {},
        physics: {
          barnesHut: {
            springLength: 350,
          },
          stabilization: true,
          repulsion: {
            damping: 0.01
          }
        },
        layout: {
          improvedLayout: false,
        },
      };

      function populateLegend(target, styles, visOptions) {
        const legendTitle = document.createElement('div');
        legendTitle.className = 'legend-title';
        legendTitle.textContent = 'Legend';
        target.appendChild(legendTitle);

        Object.entries(styles).forEach(([groupName, config]) => {
          visOptions.groups[groupName] = {
            color: {
              background: config.color,
              border: config.border,
              highlight: {
                background: config.color,
                border: '#111827',
              },
              hover: {
                background: config.color,
                border: '#111827',
              },
            },
          };

          const item = document.createElement('div');
          item.className = 'legend-item';

          const swatch = document.createElement('span');
          swatch.className = 'legend-swatch';
          swatch.style.backgroundColor = config.color;

          const label = document.createElement('span');
          label.textContent = config.label;

          item.appendChild(swatch);
          item.appendChild(label);
          target.appendChild(item);
        });
      }

      populateLegend(legend, groupStyles, options);

      function populateMetadata(network, idToNodeMap) {
        const panel = document.getElementById('metadata');
        // Track latest selected nodes for CSV export
        let latestSelectedNodes = [];

        function render(titleText, rows) {
          panel.innerHTML = '';
          const title = document.createElement('div');
          title.className = 'meta-title';
          title.textContent = titleText;
          panel.appendChild(title);

          rows.forEach(([key, value]) => {
            const row = document.createElement('div');
            row.className = 'meta-row';
            const k = document.createElement('div');
            k.className = 'meta-key';
            k.textContent = key;
            const v = document.createElement('div');
            v.className = 'meta-value';
            v.textContent = value;
            row.appendChild(k);
            row.appendChild(v);
            panel.appendChild(row);
          });
        }

        function formatNodeInfo(node) {
          const info = node.info || {};
          const meta = info.info || {};
          const lines = [];
          if (meta.name) lines.push(`Name: ${meta.name}`);
          if (meta.description) lines.push(`Description: ${meta.description}`);
          if (meta.website) lines.push(`Website: ${meta.website}`);
          if (info.identity_pubkey) lines.push(`Identity: ${info.identity_pubkey}`);
          if (info.vote_account_pubkey) lines.push(`Vote: ${info.vote_account_pubkey}`);
          if (info.activated_stake_ui) lines.push(`Stake: ${info.activated_stake_ui}`);
          
          if (info.jito_stakepool) {
              lines.push(`Jito Pool: Yes`);
              if (info.jito_stake_ui) lines.push(`Jito Stake: ${info.jito_stake_ui}`);
          } else {
              lines.push(`Jito Pool: No`);
          }
          
          if (info.sfdp_participant) {
              lines.push(`SFDP: ${info.sfdp_status || 'Participant'}`);
          } else {
              lines.push(`SFDP: No`);
          }

          if (info.ips && info.ips.length > 0) {
              lines.push(`IPs: ${info.ips.join(', ')}`);
          }
          
          return lines.join('\n');
        }

        function onSelectHandler (params) {
          const counts = { JITO: 0, SFDP: 0, SFDPandJito: 0, Regular: 0 };
          const selectedNodes = [];
          const stake = params.nodes.reduce((acc, nodeId) => {
            const node = network.body.nodes[nodeId];
            const dataNode = idToNodeMap.get(nodeId);
            const value = node?.options?.value ?? 0;
            const group = node?.options?.group ?? 'Regular';
            if (group in counts) counts[group] += 1; else counts.Regular += 1;
            if (dataNode) selectedNodes.push(dataNode);
            return acc + value;
          }
          , 0);
          
          latestSelectedNodes = selectedNodes;

          // Render selected nodes in the left sidebar
          const listEl = document.getElementById('selected-nodes-list');
          if (listEl) {
            listEl.innerHTML = '';
            if (selectedNodes.length === 0) {
              const empty = document.createElement('div');
              empty.style.color = '#6b7280';
              empty.textContent = 'No nodes selected.';
              listEl.appendChild(empty);
            } else {
              selectedNodes.forEach((node) => {
                const item = document.createElement('div');
                item.style.border = '1px solid #e5e7eb';
                item.style.borderRadius = '6px';
                item.style.padding = '8px';
                item.style.background = '#ffffff';
                item.style.whiteSpace = 'pre-wrap';
                item.textContent = formatNodeInfo(node);
                listEl.appendChild(item);
              });
            }
          }

          const rows = [
            ['Total Stake (SOL)', stake.toLocaleString('en-US')],
            ['Number of Validators', String(params.nodes.length)],
            ['Jito pool', String(counts.JITO)],
            ['SFDP only', String(counts.SFDP)],
            ['Jito + SFDP', String(counts.SFDPandJito)],
            ['No program', String(counts.Regular)],
          ];
          render('Selected Validators', rows);
        };

        // Register export handler once; uses latestSelectedNodes
        const exportBtn = document.getElementById('export-csv');
        if (exportBtn) {
          exportBtn.onclick = () => {
            const nodes = latestSelectedNodes || [];
            const headers = ['Identity','Vote','Stake (SOL)','Jito Pool','Jito Stake (SOL)','SFDP Status'];
            const rows = nodes.map(node => {
              const info = node.info || {};
              const fields = [
                info.identity_pubkey || '',
                info.vote_account_pubkey || '',
                info.activated_stake_ui || 0,
                info.jito_stakepool ? 'Yes' : 'No',
                info.jito_stake_ui || 0,
                info.sfdp_status || (info.sfdp_participant ? 'Participant' : 'No')
              ];
              // CSV-quote fields
              return fields.map(f => '"' + String(f).replace(/"/g, '""') + '"').join(',');
            });
            const csv = [headers.join(',')].concat(rows).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'selected_nodes.csv';
            a.click();
            URL.revokeObjectURL(url);
          };
        }

        network.on('select', onSelectHandler);
        
        // initial state
        render('No Selection', [['Hint', 'Click or drag select nodes to see details']]);
      
        return onSelectHandler;
      }

      let currentNetwork = null;
      let currentOnSelectHandler = null;
      let currentIdToTitle = null;
      let searchTimer = null;

      function loadData(dataSource) {
        // Clear search input
        const input = document.getElementById('search-input');
        input.value = '';

        fetch(dataSource)
          .then((response) => response.json())
          .then((data) => {
            const nodes = data.nodes;
            const edges = data.edges;
            
            // Destroy existing network if present
            if (currentNetwork) {
              currentNetwork.destroy();
            }

            // Create new network
            currentNetwork = new vis.Network(container, { nodes, edges }, options);

            // Build a map from node id to node data for metadata lookup
            const idToNodeMap = new Map();
            nodes.forEach(n => idToNodeMap.set(n.id, n));

            // grab metadata
            currentOnSelectHandler = populateMetadata(currentNetwork, idToNodeMap);

            // Build a map from node id to title for faster search
            currentIdToTitle = new Map();
            nodes.forEach(n => {
              if (typeof n.title === 'string') {
                currentIdToTitle.set(n.id, n.title);
              } else {
                currentIdToTitle.set(n.id, '');
              }
            });

            // Auto-disable physics after 5 seconds
            setTimeout(() => {
              if (currentNetwork && physicsEnabled) {
                currentNetwork.setOptions({ physics: false });
                physicsEnabled = false;
                const physicsToggle = document.getElementById('physics-toggle');
                physicsToggle.textContent = 'Physics: OFF';
                physicsToggle.classList.remove('active');
              }
            }, 15000);
          })
          .catch((error) => {
            console.error('Error loading data:', error);
            alert('Failed to load data from ' + dataSource);
          });
      }

      // Search functionality: match input text against node titles (case-insensitive)
      const input = document.getElementById('search-input');
      function performSearch(query) {
        if (!currentNetwork || !currentIdToTitle || !currentOnSelectHandler) return;
        
        const q = (query || '').trim().toLowerCase();
        if (!q) {
          // clear selection when query is empty
          currentNetwork.unselectAll();
          return;
        }
        const matchingIds = [];
        currentIdToTitle.forEach((title, id) => {
          if (title.toLowerCase().includes(q)) {
            matchingIds.push(id);
          }
        });

        if (matchingIds.length > 0) {
          // Select nodes and center focus on selection
          currentNetwork.selectNodes(matchingIds, false);
          currentNetwork.focus(matchingIds[0], { scale: 1.0, animation: true });
        } else {
          // No matches: clear selection
          currentNetwork.unselectAll();
        }
        currentOnSelectHandler({ nodes: matchingIds });
      }

      input.addEventListener('input', () => {
        if (searchTimer) clearTimeout(searchTimer);
        searchTimer = setTimeout(() => performSearch(input.value), 200);
      });

      // Data source selector
      const selector = document.getElementById('data-source-selector');
      selector.addEventListener('change', (e) => {
        loadData(e.target.value);
      });

      // Physics toggle
      let physicsEnabled = true;
      const physicsToggle = document.getElementById('physics-toggle');
      physicsToggle.addEventListener('click', () => {
        physicsEnabled = !physicsEnabled;
        if (currentNetwork) {
          if (physicsEnabled) {
            currentNetwork.setOptions({ physics: true });
            physicsToggle.textContent = 'Physics: ON';
            physicsToggle.classList.add('active');
          } else {
            currentNetwork.setOptions({ physics: false });
            physicsToggle.textContent = 'Physics: OFF';
            physicsToggle.classList.remove('active');
          }
        }
      });

      // Load initial data
      loadData('sybil_analysis_output.json');
    </script>
  </body>
</html>